{"version":3,"file":"main.js","sources":["../src/main.ts"],"sourcesContent":["import * as core from '@actions/core'\nimport { createReadStream } from 'fs'\nimport walkSync from 'walk-sync'\nimport { WebClient } from '@slack/web-api'\n\nexport async function run(): Promise<void> {\n  try {\n    core.debug('INIT!')\n    const token = core.getInput('token')\n    const channel = core.getInput('channel')\n    const screenshotsDir =\n      core.getInput('screenshotsDir') || 'cypress/screenshots'\n    const videosDir = core.getInput('videosDir') || 'cypress/videos'\n    const messageText =\n      core.getInput('message-text') ||\n      \"A Cypress test just finished. I've placed the screenshots and videos in this thread. Good pie!\"\n    const uploadType = core.getInput('uploadType') || 'both'\n\n    core.debug(`Channel: ${channel}`)\n    core.debug(`Message text: ${messageText}`)\n    core.debug(`Upload type: ${uploadType}`)\n\n    core.debug('Initializing slack SDK')\n    const slack = new WebClient(token)\n    core.debug('Slack SDK initialized successfully')\n\n    core.debug('Checking for videos and/or screenshots from cypress')\n    const videos =\n      uploadType === 'both' || uploadType === 'videos'\n        ? walkSync(videosDir, { globs: ['**/*.mp4'] })\n        : []\n    const screenshots =\n      uploadType === 'both' || uploadType === 'screenshots'\n        ? walkSync(screenshotsDir, { globs: ['**/*.png'] })\n        : []\n\n    if (videos.length <= 0 && screenshots.length <= 0) {\n      core.debug('No videos or screenshots found. Exiting!')\n      core.setOutput('result', 'No videos or screenshots found!')\n      return\n    }\n\n    core.debug(\n      `Found ${videos.length} videos and ${screenshots.length} screenshots`\n    )\n\n    core.debug('Sending initial slack message')\n    const result = await slack.chat.postMessage({\n      text: \"I've got test results coming in from Cypress. Hold tight ...\",\n      channel\n    })\n\n    const threadID = result.ts\n    const channelId = result.channel\n\n    if (!threadID || !channelId) {\n      core.error('No thread ID or channel ID returned from Slack. Exiting!')\n      core.setFailed('No thread ID or channel ID returned from Slack!')\n      return\n    }\n\n    if (\n      screenshots.length > 0 &&\n      (uploadType === 'both' || uploadType === 'screenshots')\n    ) {\n      core.debug('Uploading screenshots...')\n\n      await Promise.all(\n        screenshots.map(async screenshot => {\n          core.debug(`Uploading ${screenshot}`)\n\n          await slack.files.uploadV2({\n            filename: screenshot,\n            file: createReadStream(`${screenshotsDir}/${screenshot}`),\n            thread_ts: threadID,\n            channel_id: channelId\n          })\n        })\n      )\n\n      core.debug('...done!')\n    }\n\n    if (\n      videos.length > 0 &&\n      (uploadType === 'both' || uploadType === 'videos')\n    ) {\n      core.debug('Uploading videos...')\n\n      await Promise.all(\n        videos.map(async video => {\n          core.debug(`Uploading ${video}`)\n\n          await slack.files.uploadV2({\n            filename: video,\n            file: createReadStream(`${videosDir}/${video}`),\n            thread_ts: threadID,\n            channel_id: channelId\n          })\n        })\n      )\n\n      core.debug('...done!!')\n    }\n\n    core.debug('Updating message to indicate a successful upload')\n    await slack.chat.update({\n      ts: threadID,\n      channel: channelId,\n      text: messageText\n    })\n\n    core.setOutput('result', 'Bingo bango bongo!')\n  } catch (error) {\n    core.setFailed(error instanceof Error ? error.message : String(error))\n  }\n}\n\nrun()\n"],"names":[],"mappings":"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"}